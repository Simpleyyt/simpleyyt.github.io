---
layout: post
categories: java数据结构
title: 关于 Java ClassLoader 你真的了解吗
tagline: by 子悠
tags: 
  - 子悠

---

### 背景
类加载机制作为一个高频的面试题经常会在面试中被问到，前几天一个电话面试就问到，之前有了解过，但是没有梳理成自己的体系，所以说的有点凌乱，今天花点时间整理一下，分享给大家同时自己也好好梳理一下，顺便帮助一下有需要的人。
 
 <!--more-->
 
### 什么是类加载机制
众所周知我们编写的 Java 文件都是以.java 为后缀的文件，编译器会将我们编写的.java 的文件编译成.class 文件，简单来说类加载机制就是从文件系统将一系列的 class 文件读入 JVM 内存中为后续程序运行提供资源的动作。


### 类加载的流程
我们先看下类加载的过程中有哪些阶段，后面再对其一一解释做了什么。
![](http://www.justdojava.com/assets/images/2019/java/image_ziyou/classloader1.jpg)

简单画了一个图，从上图我们可以看出，类加载的整个过程有五个阶段，下面分别解释每个过程做了什么。

#### 加载
通过一个类的完整路径查找此类字节码文件（class 文件即二进制文件）。将二进制文件的静态存储结构转化为方法区的运行时数据结构，并利用二进制流文件创建一个Class对象，存储在 Java 堆中用于对方法区的数据结构引用的入口；

1. class 文件的来源：有一点需要注意的是类加载机制不仅可以从文件系统读取 class 文件，也可以通过网络获取，其他 jar 包或者其他程序生成，如 JSP 应用。

2. 类加载器：讲到类加载不得不讲到类加载的顺序和类加载器。Java 中大概有四种类加载器，分别是：启动类加载器（Bootstrap ClassLoader），扩展类加载器（Extension ClassLoader），系统类加载器（System ClassLoader），自定义类加载器（Custom ClassLoader），依次属于继承关系（注意这里的继承不是 Java 类里面的 extends）
![](http://www.justdojava.com/assets/images/2019/java/image_ziyou/classloader2.jpg)

3. 启动类加载器（Bootstrap ClassLoader）：主要负责加载存放在Java_Home/jre/lib下，或被-Xbootclasspath参数指定的路径下的，并且能被虚拟机识别的类库（如rt.jar，所有的java.*开头的类均被Bootstrap ClassLoader加载），启动类加载器是无法被Java程序直接引用的。

4. 扩展类加载器（Extension ClassLoader）：主要负责加载器由sun.misc.Launcher$ExtClassLoader实现，它负责加载Java_Home/jre/lib/ext目录中，或者由java.ext.dirs系统变量指定的路径中的所有类库（如javax.*开头的类），开发者可以直接使用扩展类加载器。

5. 系统类加载器（System ClassLoader）：主要负责加载器由sun.misc.Launcher$AppClassLoader来实现，它负责加载用户类路径（ClassPath）所指定的类，开发者可以直接使用该类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。

6. 自定义类加载器（Custom ClassLoader：自己开发的类加载器

7. **双亲委派原则**：类加载器在加载 class 文件的时候，遵从双亲委派原则，意思是加载依次由父加载器先执行加载动作，只有当父加载器没有加载到 class 文件时才由子类加载器进行加载。这种机制很好的保证了 Java API 的安全性，使得 JDK 的代码不会被篡改。

#### 验证
验证的过程只要是保证 class 文件的安全性和正确性，确保加载了该 class 文件不会导致 JVM 出现任何异常，不会危害JVM 的自身安全。验证包括对文件格式的验证，元数据和字节码的验证。


#### 准备
准备阶段是为类变量进行内存分配和初始化零值的过程。注意这时候分配的是类变量的内存，这些内存会在方法区中分配。此时不会分配实例变量的内存，因为实例变量是在实例化对象时一起创建在Java 堆中的。而且此时类变量是赋值为零值，即 int 类型的零值为 0，引用类型零值为 null，而不是代码中显示赋值的数值。

#### 解析
解析阶段是虚拟机将常量池中的符号引用转化为直接引用的过程。在 class 文件中常量池里面存放了字面量和符号引用，符号引用包括类和接口的全限定名以及字段和方法的名称与描述符。在 JVM 动态链接的时候需要根据这些符号引用来转换为直接引用存放内存使用。

#### 初始化
初始化的阶段是类加载的最后一步，这个阶段主要是执行 java 代码，进行相关初始化的动作。

### 总结
整个类加载机制是我们程序运行的开始，虽然这些动作都是 JVM 帮我们自动完成，开发人员在不需要定制类加载器的时候是不会涉及到底层细节的，但是作为一个有追求的程序员，我们还是要知道一些原理，这样不管是在面试的时候还是对自己的提升都有很大的帮助。
